<?xml version="1.0"  encoding="UTF-8" ?>
<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.
-->


<bindings xmlns="http://www.mozilla.org/xbl"
        xmlns:xbl="http://www.mozilla.org/xbl"
        xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">

    <!-- Binding around a browser that is used to load a web page -->
    <binding id="slimer_navigator">
        <content flex="1">
            <xul:browser anonid="mBrowser" flex="1"
                         type="content-targetable" autoscroll="true" disablesecurity="false"/>
        </content>
        <implementation>
            <constructor>
                <![CDATA[
                this.initMessageManager();
                this.browser.messageManager.loadFrameScript('chrome://slimerjs/content/navigatorFrameScript.js', true);
            ]]>
            </constructor>
            <destructor>
                this.resetBrowser();
            </destructor>

            <field name="browser" readonly="true">
                document.getAnonymousElementByAttribute(this, "anonid", "mBrowser");
            </field>

            <field name="onpageloaded">null</field>
            <field name="onloadstarted">null</field>
            <field name="onloadfinished">null</field>
            <field name="webPage">null</field>
            <field name="requestCounter">0</field>
            <method name="resetBrowser">
                <body>
                    this.onpageloaded = null;
                    this.onloadstarted = null;
                    this.browser.stop();
                    this.browser.removeProgressListener(this.mProgressListener);
                    this.webPage = null;
                    //this.browser.sessionHistory.PurgeHistory(1000);
                    this.browser.destroy();
                </body>
            </method>

            <method name="initMessageManager">
                <body><![CDATA[
                var me = this;
                var mm = this.browser.messageManager;

                var pageLoaderListener = function(message){
                    let channel = me.browser.docShell.currentDocumentChannel
                    let success = "success";
                    try {
                        if (channel.URI.spec != 'about:blank') {
                            channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);
                            success = channel.requestSucceeded?"success":"fail:"+channel.responseStatus+" "+channel.responseStatusText;
                        }
                    }
                    catch(e){
                        //dump("pageloaded: NOT HTTP CHANNEL\n"+channel.URI.spec+"\n")
                        success = 'fail';
                    }

                    if (me.onloadfinished) {
                        me.onloadfinished();
                    }

                    if (me.webPage && me.webPage.onLoadFinished)
                        me.webPage.onLoadFinished(success)

                    if (me.onpageloaded)
                        me.onpageloaded(success);
                }

                // listener for the first about:blank page load
                var firstPageLoaderListener = function(message){
                    let channel = me.browser.docShell.currentDocumentChannel
                    if (channel.URI.spec != 'about:blank') {
                        return;
                    }
                    // the initial about:blank is loaded, we can now
                    // initialize progress listeners and so one,
                    // and we can send the BrowserReady event.
                    mm.removeMessageListener("pageloaded", firstPageLoaderListener);
                    me.initProgressListener();
                    mm.addMessageListener("pageloaded", pageLoaderListener);
                    var evt = document.createEvent("Event");
                    evt.initEvent("BrowserReady", true, false);
                    me.dispatchEvent(evt);
                }

                mm.addMessageListener("pageloaded", firstPageLoaderListener);
                ]]></body>
            </method>

            <method name="initProgressListener">
                <body>
                <![CDATA[
                    let ci = Components.interfaces;
                    let WPL = ci.nsIWebProgressListener;
                    let nav = this;
                    this.mProgressListener = {
                        _mainPageLoading : false,
                        QueryInterface : function(aIID)
                        {
                          if (aIID.equals(WPL) ||
                              aIID.equals(ci.nsIWebProgressListener2) ||
                              aIID.equals(ci.nsISupportsWeakReference) ||
                              aIID.equals(ci.nsISupports))
                            return this;
                          throw Components.results.NS_NOINTERFACE;
                        },

                        onLocationChange : function(aWebProgress, aRequest, aLocation, aFlags)
                        {
                            let failure = aFlags & WPL.LOCATION_CHANGE_ERROR_PAGE;
                            if (failure) {
                                if (nav.onpageloaded)
                                    nav.onpageloaded("fail");
                                return;
                            }
                            if (!nav.webPage)
                                return;
                            //let insidePage = aFlags & WPL.LOCATION_CHANGE_SAME_DOCUMENT;
                            if (nav.webPage.onUrlChanged)
                                nav.webPage.onUrlChanged(aLocation.spec);
                        },
                        onStateChange : function(aWebProgress, aRequest, aStateFlags, aStatus)
                        {
                            let uri = ''
                            if ((aRequest instanceof ci.nsIChannel || "URI" in aRequest)) {
                                if (!nav.webPage)
                                    return;
                                uri = aRequest.URI.spec
                            }
                            else {
                                /*dump("onStateChange no URI");
                                if (aStateFlags & WPL.STATE_START)
                                    dump( " START");
                                if (aStateFlags & WPL.STATE_TRANSFERRING)
                                    dump( " TRANS");
                                if (aStateFlags & WPL.STATE_NEGOTIATING)
                                    dump( " NEGO");
                                if (aStateFlags & WPL.STATE_STOP)
                                    dump( " STOP");
                                if (aStateFlags & WPL.STATE_IS_REQUEST)
                                    dump( " REQ");
                                if (aStateFlags & WPL.STATE_IS_DOCUMENT)
                                    dump( " DOC");
                                if (aStateFlags & WPL.STATE_IS_NETWORK)
                                    dump( " NET");
                                if (aStateFlags & WPL.STATE_IS_WINDOW)
                                    dump( " WIN");
                                dump("\n")*/
                                return;
                            }

                            // aStateFlags:
                            // STATE_START, STATE_REDIRECTING, STATE_TRANSFERRING, STATE_NEGOTIATING, STATE_STOP
                            // STATE_IS_REQUEST, STATE_IS_DOCUMENT, STATE_IS_NETWORK, STATE_IS_WINDOW

                            /*dump("onStateChange URI:"+uri);
                            if (aStateFlags & WPL.STATE_START)
                                dump( " START");
                            if (aStateFlags & WPL.STATE_TRANSFERRING)
                                dump( " TRANS");
                            if (aStateFlags & WPL.STATE_NEGOTIATING)
                                dump( " NEGO");
                            if (aStateFlags & WPL.STATE_STOP)
                                dump( " STOP");
                            if (aStateFlags & WPL.STATE_IS_REQUEST)
                                dump( " REQ");
                            if (aStateFlags & WPL.STATE_IS_DOCUMENT)
                                dump( " DOC");
                            if (aStateFlags & WPL.STATE_IS_NETWORK)
                                dump( " NET");
                            if (aStateFlags & WPL.STATE_IS_WINDOW)
                                dump( " WIN");*/

                            if (!this._mainPageLoading) {
                                //dump("\n")
                                if ( (aStateFlags & WPL.STATE_START) && (aStateFlags & WPL.STATE_IS_WINDOW)) {
                                    this._mainPageLoading = uri;

                                    // phantomjs call onInitialized twice.. don't know why.
                                    // let's imitate it
                                    if (nav.webPage.onInitialized)
                                        nav.webPage.onInitialized();

                                    if (nav.onloadstarted)
                                        nav.onloadstarted();

                                    if (nav.webPage.onLoadStarted)
                                        nav.webPage.onLoadStarted();
                                }
                                return;
                            }

                            // ignore all request that are not the main request
                            if (this._mainPageLoading != uri) {
                                //dump(" IGNORED\n");
                                return;
                            }
                            //dump("\n")

                            if ( (aStateFlags & WPL.STATE_STOP) && (aStateFlags & WPL.STATE_IS_REQUEST)) {
                                if (nav.webPage.onInitialized)
                                    nav.webPage.onInitialized();
                            }
                        },

                        onStatusChange : function(aWebProgress, aRequest, aStatus, aMessage){},
                        onSecurityChange : function(aWebProgress, aRequest, aState) { },
                        onRefreshAttempted : function(aWebProgress, aURI, aDelay, aSameURI){},

                        debug : function(aWebProgress, aRequest) {
                            //aWebProgress -> browser
                            //aWebProgress.DOMWindow
                            //aWebProgress.isLoadingDocument
                            //arequest  cancel(), resume(), suspend(), isPending()
                        },
                        onProgressChange : function (aWebProgress, aRequest,
                                aCurSelfProgress, aMaxSelfProgress,
                                aCurTotalProgress, aMaxTotalProgress)
                        {},
                        onProgressChange64 : function (aWebProgress, aRequest,
                                aCurSelfProgress, aMaxSelfProgress,
                                aCurTotalProgress, aMaxTotalProgress)
                        {}

                    }
                    this.browser.addProgressListener(this.mProgressListener, Components.interfaces.nsIWebProgress.NOTIFY_ALL);
                ]]>
                </body>
            </method>
        </implementation>
        <handlers>
        </handlers>
    </binding>
</bindings>


